<script>
  const segments = [
    { label: 'Mit mir joggen gehen', weight: 0.75, color: '#4caf50' },
    { label: 'Kuchen backen', weight: 0.25, color: '#ff7043' }
  ];

  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  const size = Math.min(canvas.width, canvas.height);
  const cx = canvas.width/2, cy = canvas.height/2, radius = size*0.45;

  let angleAccumulator = 0;
  for (let s of segments){
    s.start = angleAccumulator;
    s.span = s.weight * 360;
    s.end = s.start + s.span;
    angleAccumulator += s.span;
  }

  function degToRad(d){ return (d-90) * Math.PI/180; }

  function drawWheel(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for (let s of segments){
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,radius,degToRad(s.start),degToRad(s.end));
      ctx.closePath();
      ctx.fillStyle = s.color;
      ctx.fill();

      const midDeg = (s.start + s.end)/2;
      const tx = cx + Math.cos(degToRad(midDeg)) * (radius*0.6);
      const ty = cy + Math.sin(degToRad(midDeg)) * (radius*0.6);
      ctx.save();
      ctx.translate(tx,ty);
      ctx.rotate((midDeg-90) * Math.PI/180);
      ctx.fillStyle = '#fff';
      ctx.font = '20px system-ui,Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      wrapText(ctx, s.label, 0, 0, 120, 20);
      ctx.restore();
    }
    ctx.beginPath(); ctx.arc(cx,cy, radius*0.22, 0, Math.PI*2); ctx.fillStyle = '#222'; ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font='18px system-ui'; ctx.textAlign='center'; ctx.fillText('Los!', cx, cy+4);
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight){
    const words = text.split(' ');
    let line = '';
    let offsetY = 0;
    for (let n = 0; n < words.length; n++) {
      const testLine = line + words[n] + ' ';
      const metrics = ctx.measureText(testLine);
      if (metrics.width > maxWidth && n > 0) {
        ctx.fillText(line, x, y + offsetY);
        line = words[n] + ' ';
        offsetY += lineHeight;
      } else {
        line = testLine;
      }
    }
    ctx.fillText(line, x, y + offsetY);
  }

  drawWheel();

  const spinBtn = document.getElementById('spinBtn');
  const resultEl = document.getElementById('result');
  let spinning = false;
  let currentRotation = 0; // merken, wo wir stehen

  function pickSegmentByPointer(finalRotationDeg){
    // Winkel der oberen Spitze relativ zum Rad bestimmen
    let pointerWheelAngle = ((-finalRotationDeg) % 360 + 360) % 360;
    for (let s of segments){
      if (pointerWheelAngle >= s.start && pointerWheelAngle < s.end) return s;
    }
    return segments[segments.length-1];
  }

  spinBtn.addEventListener('click', ()=>{
    if (spinning) return;
    spinning = true;
    spinBtn.disabled = true;
    resultEl.textContent = '';

    // Zufällig Segment wählen anhand Gewichtung
    const r = Math.random();
    let cum = 0; let chosen = segments[segments.length-1];
    for (let s of segments){ cum += s.weight; if (r < cum){ chosen = s; break; } }

    const mid = (chosen.start + chosen.end)/2;
    // wir wollen, dass die obere Spitze (0°) auf dieses Feld zeigt
    const targetAngle = mid;
    const finalRotationMod360 = ((0 - targetAngle) % 360 + 360) % 360;

    const fullTurns = Math.floor(Math.random()*3) + 4;
    const finalRotation = currentRotation + fullTurns*360 + finalRotationMod360;
    currentRotation = finalRotation % 360; // für nächste Drehung merken

    canvas.style.transition = 'transform 4s cubic-bezier(.12,.9,.18,1)';
    requestAnimationFrame(()=>{
      canvas.style.transform = `rotate(${finalRotation}deg)`;
    });

    canvas.addEventListener('transitionend', function handler(){
      canvas.removeEventListener('transitionend', handler);
      const seg = pickSegmentByPointer(finalRotation);
      resultEl.textContent = 'Ergebnis: ' + seg.label;
      spinning = false; spinBtn.disabled = false;
    });
  });
</script>
